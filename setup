#!/bin/sh

# Get the directory path where the script is located
script_dir=$(dirname "$(realpath "$0")")
system_dir="$script_dir/system"
target_file="$system_dir/hardware.nix"

# Ensure the system directory exists
mkdir -p "$system_dir"

# Function to generate hardware configuration
generate_hardware_config() {
    if [ ! -f "$target_file" ]; then
        echo "File 'hardware.nix' not found. Generating hardware configuration..."
        if nixos-generate-config --show-hardware-config > "$target_file"; then
            echo "'hardware.nix' has been generated successfully."
        else
            echo "Error: Failed to generate 'hardware.nix'."
            exit 1
        fi
    else
        echo "File 'hardware.nix' already exists. No action taken."
    fi
}

# Function to display menu options
display_menu() {
    echo "Select an option:"
    echo "1) Clear (Remove old generations)"
    echo "2) Delete Historical Versions older than 7 Days"
    echo "3) Rebuild System"
    echo "4) Rebuild System with less RAM (It takes longer)"
    echo "5) Exit"
    read -p "Enter the number of your choice: " choice
}

# Main script execution
generate_hardware_config

while true; do
    display_menu
    case $choice in
        1)
            echo "Running 'sudo nix-collect-garbage --delete-old'..."
            sudo nix-collect-garbage --delete-old || echo "Error: Failed to clear old generations."
            ;;
        2)
            echo "Deleting all historical versions older than 7 days..."
            if ! sudo nix profile wipe-history --older-than 7d --profile /nix/var/nix/profiles/system; then
                echo "Error: Failed to delete historical versions."
            fi
            ;;
        3)
            echo "Rebuilding the system..."
            if ! sudo nixos-rebuild boot --flake .; then
                echo "Error: Failed to rebuild the system."
            fi
            ;;
        4)
            echo "Rebuilding the system with less RAM..."
            if ! sudo nixos-rebuild boot --flake . --cores 1 -j 1; then
                echo "Error: Failed to rebuild the system with limited resources."
            fi
            ;;
        5)
            echo "Exiting. Bye!"
            exit 0
            ;;
        *)
            echo "Invalid option. Please try again."
            ;;
    esac
done
